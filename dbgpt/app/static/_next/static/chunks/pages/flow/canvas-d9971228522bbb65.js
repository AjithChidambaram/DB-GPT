(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[997],{76735:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/flow/canvas",function(){return a(4551)}])},45247:function(e,t,a){"use strict";var l=a(85893),n=a(50888);t.Z=function(e){let{visible:t}=e;return t?(0,l.jsx)("div",{className:"absolute w-full h-full top-0 left-0 flex justify-center items-center z-10 bg-white dark:bg-black bg-opacity-50 dark:bg-opacity-50 backdrop-blur-sm text-3xl animate-fade animate-duration-200",children:(0,l.jsx)(n.Z,{})}):null}},4551:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return J}});var l=a(85893),n=a(50489),s=a(45247),o=a(24969),r=a(79531),i=a(40411),c=a(2487),d=a(7134),u=a(32983),f=a(74627),x=a(96074),p=a(47221),m=a(71577),h=a(67294),g=a(67421);let{Search:j}=r.default;var w=()=>{let{t:e}=(0,g.$G)(),[t,a]=(0,h.useState)([]),[s,r]=(0,h.useState)([]),[w,b]=(0,h.useState)([]);async function v(){let[e,t]=await (0,n.Vx)((0,n.As)());t&&t.length>0&&(a(t),_(t))}function _(e){r((e||[]).filter(e=>"operator"===e.flow_type)),b((e||[]).filter(e=>"resource"===e.flow_type))}(0,h.useEffect)(()=>{v()},[]);let y=(0,h.useMemo)(()=>[{key:"operator",label:"Operator",children:N(s),extra:(0,l.jsx)(i.Z,{showZero:!0,count:s.length||0,style:{backgroundColor:s.length>0?"#52c41a":"#7f9474"}})},{key:"resource",label:"Resource",children:N(w),extra:(0,l.jsx)(i.Z,{showZero:!0,count:w.length||0,style:{backgroundColor:w.length>0?"#52c41a":"#7f9474"}})}],[s,w]);function N(t){return(null==t?void 0:t.length)>0?(0,l.jsx)(c.Z,{className:"overflow-hidden overflow-y-auto",itemLayout:"horizontal",dataSource:t,renderItem:e=>(0,l.jsx)(c.Z.Item,{className:"cursor-move hover:bg-[#F1F5F9] dark:hover:bg-theme-dark p-0 py-2",draggable:!0,onDragStart:t=>{t.dataTransfer.setData("application/reactflow",JSON.stringify(e)),t.dataTransfer.effectAllowed="move"},children:(0,l.jsx)(c.Z.Item.Meta,{className:"flex items-center justify-center",avatar:(0,l.jsx)(d.C,{src:e.icon||"/icons/node/default_node_icon.svg",size:"large"}),title:(0,l.jsx)("p",{className:"line-clamp-1 font-medium",children:e.label}),description:(0,l.jsx)("p",{className:"line-clamp-2",children:e.description})})})}):(0,l.jsx)(u.Z,{className:"px-2",description:e("no_node")})}return(0,l.jsx)(f.Z,{placement:"bottom",trigger:["click"],content:(0,l.jsxs)("div",{className:"w-[320px] overflow-hidden overflow-y-auto scrollbar-default",children:[(0,l.jsx)("p",{className:"my-4 font-bold",children:e("add_node")}),(0,l.jsx)(j,{placeholder:"Search node",onSearch:function(e){if(e){let t=e.toLowerCase(),a=s.filter(e=>e.label.toLowerCase().includes(t)),l=w.filter(e=>e.label.toLowerCase().includes(t));r(a),b(l)}else _(t)}}),(0,l.jsx)(x.Z,{className:"my-2"}),(0,l.jsx)(p.Z,{className:"max-h-[538px]",size:"small",defaultActiveKey:["operator"],ghost:!0,items:y})]}),children:(0,l.jsx)(m.ZP,{type:"primary",className:"flex items-center justify-center rounded-full left-4 top-4",style:{zIndex:1050},icon:(0,l.jsx)(o.Z,{})})})},b=a(36851),v=a(25675),_=a.n(v),y=a(48928),N=a(84567),k=e=>{let{optional:t}=e;return t?null:(0,l.jsx)("span",{className:"text-red-600 align-middle inline-block",children:"\xa0*"})},Z=a(2453),C=a(76315),E=a(83062),S=a(45605),O=e=>{let{node:t,data:a,type:n,label:s,index:o}=e,{t:r}=(0,g.$G)(),i=(0,b._K)();return(0,l.jsxs)("div",{className:"relative flex items-center",children:[(0,l.jsx)(b.HH,{className:"w-2 h-2",type:n,position:"source"===n?b.Ly.Right:b.Ly.Left,id:"".concat(t.id,"|").concat(s,"|").concat(o),isValidConnection:e=>(function(e){let{sourceHandle:t,targetHandle:a,source:l,target:n}=e,s=i.getNode(l),o=i.getNode(n),{flow_type:c}=null==s?void 0:s.data,{flow_type:d}=null==o?void 0:o.data,u=null==t?void 0:t.split("|")[1],f=null==a?void 0:a.split("|")[1],x=null==t?void 0:t.split("|")[2],p=null==a?void 0:a.split("|")[2],m=null==o?void 0:o.data[f][p].type_cls;if(c===d&&"operator"===c){let e=null==s?void 0:s.data[u][x].type_cls;return e===m}if("resource"===c&&"operator"===d){let e=null==s?void 0:s.data.parent_cls;return e.includes(m)}return Z.ZP.warning(r("connect_warning")),!1})(e)}),(0,l.jsxs)(C.Z,{className:"p-2",children:[a.label,":",(0,l.jsx)(k,{optional:a.optional}),a.description&&(0,l.jsx)(E.Z,{title:a.description,children:(0,l.jsx)(S.Z,{className:"ml-2"})})]})]})},z=e=>{let{node:t,data:a,label:n,index:s}=e;function o(e){a.value=e}if("resource"===a.category)return(0,l.jsx)(O,{node:t,data:a,type:"target",label:n,index:s});if("common"===a.category){let e=a.default||a.value;switch(a.type_name){case"int":return(0,l.jsxs)("div",{className:"p-2 text-sm",children:[(0,l.jsxs)("p",{children:[a.label,":",(0,l.jsx)(k,{optional:a.optional})]}),(0,l.jsx)(y.Z,{className:"w-full",defaultValue:e,onChange:e=>{o(e.target.value)}})]});case"str":return(0,l.jsxs)("div",{className:"p-2 text-sm",children:[(0,l.jsxs)("p",{children:[a.label,":",(0,l.jsx)(k,{optional:a.optional})]}),(0,l.jsx)(r.default,{className:"w-full",defaultValue:e,onChange:e=>{o(e.target.value)}})]});case"bool":return(0,l.jsx)("div",{className:"p-2 text-sm",children:(0,l.jsxs)("p",{children:[a.label,":",(0,l.jsx)(k,{optional:a.optional}),(0,l.jsx)(N.Z,{className:"ml-2",defaultChecked:e,onChange:e=>{o(e.target.value)}})]})})}}},F=a(94184),T=a.n(F),P=a(57132),V=a(48689),L=e=>{let{children:t}=e;return(0,l.jsx)("div",{className:"flex justify-center items-center w-8 h-8 rounded-full hover:bg-stone-200 dark:hover:bg-zinc-900",children:t})};function D(e){let{label:t}=e;return(0,l.jsx)("div",{className:"w-full h-8 bg-stone-100 dark:bg-zinc-700 px-2 flex items-center justify-center",children:t})}let I=(e,t)=>{let a=0;return t.forEach(t=>{t.data.name===e.name&&a++}),"".concat(e.id,"_").concat(a)},K=e=>{let{nodes:t,edges:a,...l}=e,n=t.map(e=>{let{positionAbsolute:t,...a}=e;return{position_absolute:t,...a}}),s=a.map(e=>{let{sourceHandle:t,targetHandle:a,...l}=e;return{source_handle:t,target_handle:a,...l}});return{nodes:n,edges:s,...l}};var M=a(60219),R=a(12069),A=a(39332),$=a(24885),G=a(59819);a(4583);let X={customNode:e=>{let{data:t}=e,{inputs:a,outputs:n,flow_type:s}=t,o=function(e){let t=e.filter(e=>"resource"===e.category),a=e.filter(e=>"common"===e.category);return[...t,...a]}(t.parameters||[]),[r,i]=(0,h.useState)(!1),c=(0,b._K)();return(0,l.jsx)(f.Z,{placement:"rightTop",content:(0,l.jsxs)("div",{children:[(0,l.jsx)(L,{children:(0,l.jsx)(P.Z,{className:"block text-lg cursor-pointer",onClick:function(){}})}),(0,l.jsx)(V.Z,{className:"block text-lg cursor-pointer",onClick:function(){let e=c.getNodes();console.log("delete node",e),c.setNodes(e=>{let a=e.filter(e=>e.id!==t.id);return a}),c.setEdges(e=>e.filter(e=>e.source!==t.id&&e.target!==t.id))}})]}),children:(0,l.jsxs)("div",{className:T()("w-72 h-auto rounded-xl shadow-md p-0 border bg-white dark:bg-zinc-800 cursor-grab",{"border-blue-500":t.selected||r,"border-stone-400 dark:border-white":!t.selected&&!r,"border-dashed":"operator"!==s}),onMouseEnter:function(){i(!0)},onMouseLeave:function(){i(!1)},children:[(0,l.jsxs)("div",{className:"flex flex-row items-center p-2",children:[(0,l.jsx)(_(),{src:t.icon||"".concat("/icons/node/").concat(t.name||"default_node_icon",".svg"),width:24,height:24,alt:""}),(0,l.jsx)("p",{className:"ml-2 text-lg font-bold text-ellipsis overflow-hidden whitespace-nowrap",children:t.label})]}),a&&a.length>0&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(D,{label:"Inputs"}),(a||[]).map((e,a)=>(0,l.jsx)(O,{node:t,data:e,type:"target",label:"inputs",index:a},"".concat(t.id,"_input_").concat(a)))]}),o&&o.length>0&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(D,{label:"Parameters"}),(o||[]).map((e,a)=>(0,l.jsx)(z,{node:t,data:e,label:"parameters",index:a},"".concat(t.id,"_param_").concat(a)))]}),"operator"===s&&(null==n?void 0:n.length)>0?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(D,{label:"Outputs"}),(n||[]).map((e,a)=>(0,l.jsx)(O,{node:t,data:e,type:"source",label:"outputs",index:a},"".concat(t.id,"_input_").concat(a)))]}):"resource"===s?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(D,{label:"Outputs"}),(0,l.jsx)(O,{node:t,data:t,type:"source",label:"outputs",index:0},"".concat(t.id,"_input_0"))]}):void 0]})})}},q={buttonedge:e=>{let{id:t,sourceX:a,sourceY:n,targetX:s,targetY:o,sourcePosition:r,targetPosition:i,style:c={},data:d,markerEnd:u}=e,[f,x,p]=(0,b.OQ)({sourceX:a,sourceY:n,sourcePosition:r,targetX:s,targetY:o,targetPosition:i}),m=(0,b._K)();return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(b.u5,{id:t,style:c,path:f,markerEnd:u}),(0,l.jsx)("foreignObject",{width:40,height:40,x:x-20,y:p-20,className:"bg-transparent w-10 h-10 relative",requiredExtensions:"http://www.w3.org/1999/xhtml",children:(0,l.jsx)("button",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-5 h-5 rounded-full bg-stone-400 dark:bg-zinc-700 cursor-pointer text-sm",onClick:e=>{e.stopPropagation(),m.setEdges(m.getEdges().filter(e=>e.id!==t))},children:"\xd7"})})]})}},H=()=>{let{t:e}=(0,g.$G)(),[t,a]=Z.ZP.useMessage(),o=(0,A.useSearchParams)(),i=(null==o?void 0:o.get("id"))||"",c=(0,b._K)(),[d,u]=(0,h.useState)(!1),[f,p,m]=(0,b.Rr)([]),[j,v,_]=(0,b.ll)([]),y=(0,h.useRef)(null),[N,k]=(0,h.useState)(!1),[C,E]=(0,h.useState)("");async function S(){u(!0);let[e,t]=await (0,n.Vx)((0,n._d)(i));if(t){let e=K(t.flow_data);E(t.name),p(e.nodes.map(e=>({...e,type:"customNode"}))),v(e.edges.map(e=>({...e,type:"buttonedge"})))}u(!1)}(0,h.useEffect)(()=>{i&&S()},[i]);let O=(0,h.useCallback)(e=>{e.preventDefault();let t=y.current.getBoundingClientRect(),a=e.dataTransfer.getData("application/reactflow");if(!a||void 0===a)return;let l=JSON.parse(a),n=c.screenToFlowPosition({x:e.clientX-t.left,y:e.clientY-t.top}),s=I(l,c.getNodes()),o={id:s,position:n,type:"customNode",data:l};p(e=>e.concat(o).map(e=>(e.id===o.id?e.data={...e.data,selected:!0}:e.data={...e.data,selected:!1},e)))},[c]),z=(0,h.useCallback)(e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},[]);async function F(){let a=K(c.toObject());if(i){let[,,l]=await (0,n.Vx)((0,n.ao)(i,{name:C,uid:i,flow_data:a}));(null==l?void 0:l.success)?t.success(e("save_flow_success")):(null==l?void 0:l.err_msg)&&t.error(null==l?void 0:l.err_msg)}else{if(!C)return t.warning(e("flow_name_required"));let[l,s]=await (0,n.Vx)((0,n.zd)({name:C,flow_data:a}));if(null==s?void 0:s.uid){t.success(e("save_flow_success"));let a=window.history;a.pushState(null,"","/flow/canvas?id=".concat(s.uid))}k(!1)}}return(0,l.jsxs)("div",{className:"p-2",children:[(0,l.jsx)(s.Z,{visible:d}),(0,l.jsx)("div",{className:"my-2 flex flex-row justify-end items-center",children:(0,l.jsx)("div",{className:"w-8 h-8 rounded-md bg-stone-300 flext justify-center items-center text-center",children:(0,l.jsx)(M.Z,{className:"text-xl",onClick:function(){i?F():k(!0)}})})}),(0,l.jsx)(x.Z,{className:"mt-2 mb-0"}),(0,l.jsx)("div",{className:"min-h-screen w-full h-full",ref:y,children:(0,l.jsxs)(b.x$,{nodes:f,edges:j,nodeTypes:X,edgeTypes:q,onNodesChange:m,onEdgesChange:_,onNodeClick:function(e,t){c.setNodes(e=>e.map(e=>(e.id===t.id?e.data={...e.data,selected:!0}:e.data={...e.data,selected:!1},e)))},onConnect:function(e){let t={...e,type:"buttonedge",id:"".concat(e.source,"|").concat(e.target)};v(e=>(0,b.Z_)(t,e))},onDrop:O,onDragOver:z,minZoom:.1,fitView:!0,children:[(0,l.jsx)($.Z,{className:"flex flex-row items-center",position:"bottom-center"}),(0,l.jsx)(G.A,{color:"#aaa",gap:16}),(0,l.jsx)(w,{})]})}),(0,l.jsx)(R.default,{title:e("flow_modal_title"),open:N,onOk:F,onCancel:()=>{k(!1)},children:(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("p",{children:e("flow_name")}),(0,l.jsx)(r.default,{onChange:e=>{E(e.target.value)}})]})}),a]})};function J(){return(0,l.jsx)(b.tV,{children:(0,l.jsx)(H,{})})}}},function(e){e.O(0,[241,113,503,9,810,411,928,884,487,434,961,774,888,179],function(){return e(e.s=76735)}),_N_E=e.O()}]);